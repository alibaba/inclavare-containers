From 3c8810889ad595045ce1a2c241f94ab970d339c0 Mon Sep 17 00:00:00 2001
From: zhiminghufighting <13764765163@163.com>
Date: Mon, 19 Apr 2021 11:00:01 +0800
Subject: [PATCH] enable shelter generate rpm and deb pakcage

Signed-off-by: zhiminghufighting <13764765163@163.com>
---
 Makefile                              |  4 +-
 shelter/Makefile                      | 13 +++++-
 shelter/dist/Makefile                 | 32 ++++++++++++++
 shelter/dist/deb/build.sh             | 41 ++++++++++++++++++
 shelter/dist/deb/debian/changelog     | 17 ++++++++
 shelter/dist/deb/debian/compat        |  1 +
 shelter/dist/deb/debian/control       | 12 ++++++
 shelter/dist/deb/debian/rules         | 16 +++++++
 shelter/dist/deb/debian/source/format |  1 +
 shelter/dist/rpm/shelter.spec         | 61 +++++++++++++++++++++++++++
 10 files changed, 194 insertions(+), 4 deletions(-)
 create mode 100644 shelter/dist/Makefile
 create mode 100755 shelter/dist/deb/build.sh
 create mode 100644 shelter/dist/deb/debian/changelog
 create mode 100644 shelter/dist/deb/debian/compat
 create mode 100644 shelter/dist/deb/debian/control
 create mode 100755 shelter/dist/deb/debian/rules
 create mode 100644 shelter/dist/deb/debian/source/format
 create mode 100644 shelter/dist/rpm/shelter.spec

diff --git a/Makefile b/Makefile
index effa742..301f327 100644
--- a/Makefile
+++ b/Makefile
@@ -1,8 +1,8 @@
 .PHONY: all install clean uninstall package
 
 export INCLAVARE_CONTAINERS_VERSION := $(shell cat ./VERSION)
-stable_components := rune shim epm sgx-tools
-unstable_components := shelter
+stable_components := rune shim epm sgx-tools shelter
+unstable_components := 
 components := $(stable_components) $(unstable_components)
 
 all:
diff --git a/shelter/Makefile b/shelter/Makefile
index de9599d..3b53eae 100644
--- a/shelter/Makefile
+++ b/shelter/Makefile
@@ -5,9 +5,11 @@ SGX_RA_TLS_LIB := $(TOPDIR)/ra-tls/build/lib
 SGX_RA_TLS_INC := $(TOPDIR)/ra-tls/build/include
 SGX_SDK := /opt/intel/sgxsdk
 SGX_DCAP_INC ?=
+DESTDIR ?=
 INCDIR ?=
 DEBUG ?= 0
 EXTRA_FLAGS ?=
+APP := shelter
 WOLFSSL_RA_LIBS := $(SGX_RA_TLS_LIB)/libwolfssl.a
 WOLFSSL_RA_LIBS += $(SGX_RA_TLS_LIB)/libra-challenger.a
 export SGX_RA_TLS_LIB SGX_RA_TLS_INC
@@ -70,9 +72,16 @@ $(CURRENTDIR)/verification/verification.a:
 $(CURRENTDIR)/remoteattestation/remoteattestation.a: 
 	$(MAKE) -C remoteattestation
 
-install:
+PREFIX := $(DESTDIR)/usr/local
+BINDIR := $(PREFIX)/bin
+install:$(APP)
+	@install -D -m0755 $(APP) "$(BINDIR)"
+
 uninstall:
+	@rm -f $(BINDIR)/$(APP)
 
+package:
+	$(MAKE) -C dist package
 clean:
 	rm -f *.o shelter
 	$(MAKE) -C $(SGX_RA_TLS) clean
@@ -80,4 +89,4 @@ clean:
 	$(MAKE) -C remoteattestation clean
 	$(MAKE) -C utils clean
 
-.PHONY: clean build-ra-tls install uninstall
+.PHONY: clean build-ra-tls install uninstall package
diff --git a/shelter/dist/Makefile b/shelter/dist/Makefile
new file mode 100644
index 0000000..4fbe853
--- /dev/null
+++ b/shelter/dist/Makefile
@@ -0,0 +1,32 @@
+PROJECT_DIR := $(shell cd ../..; pwd)
+RPMBUILD_DIR := $(shell mktemp -u /tmp/rpmbuild.XXXX)
+RELEASE_TARBALL_URL := https://github.com/alibaba/inclavare-containers/archive/v$(INCLAVARE_CONTAINERS_VERSION).tar.gz
+RELEASE_TARBALL_FILE := $(RPMBUILD_DIR)/SOURCES/v$(INCLAVARE_CONTAINERS_VERSION).tar.gz
+RELEASE_TARBALL_EXIST := $(shell if [ -f $(RELEASE_TARBALL_FILE) ]; then echo "y"; else echo "n"; fi;)
+
+release-tarball:
+ifneq ($(RELEASE_TARBALL_EXIST), y)
+	@mkdir -p $(RPMBUILD_DIR)/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
+	@wget -P $(RPMBUILD_DIR)/SOURCES $(RELEASE_TARBALL_URL)
+endif
+
+rpm: release-tarball
+	@rpmbuild -D "_topdir $(RPMBUILD_DIR)" -ba rpm/shelter.spec
+	@cp $(RPMBUILD_DIR)/RPMS/x86_64/*.rpm $(PROJECT_DIR)
+	@rm -rf $(RPMBUILD_DIR)
+	@echo "the rpms of shelter located in $(PROJECT_DIR)"
+
+deb:
+	@cd deb && ./build.sh
+	@echo "the debs of shelter located in $(PROJECT_DIR)"
+
+package:
+ifeq (/etc/debian_version, $(wildcard /etc/debian_version))
+	make deb
+else ifeq (/etc/redhat-release, $(wildcard /etc/redhat-release))
+	make rpm
+else
+	@echo "error! don't support generating packages on this system"
+endif
+
+.PHONY: release-tarball rpm deb package
diff --git a/shelter/dist/deb/build.sh b/shelter/dist/deb/build.sh
new file mode 100755
index 0000000..c976d3e
--- /dev/null
+++ b/shelter/dist/deb/build.sh
@@ -0,0 +1,41 @@
+#!/bin/bash
+
+PROJECT_DIR=$(cd ../../..; pwd)
+DEBBUILD_DIR=$(mktemp -u /tmp/debbuild.XXXX)
+SCRIPT_DIR=$(pwd)
+PACKAGE=shelter
+PROJECT=inclavare-containers
+VERSION=$(cd ../../..; cat ./VERSION)
+RELEASE_TARBALL=$DEBBUILD_DIR/v$VERSION.tar.gz
+RELEASE_TARBALL_URL=https://github.com/alibaba/inclavare-containers/archive/v$VERSION.tar.gz
+TARBALL_NAME=$PACKAGE\_$VERSION.orig.tar.gz
+DEB_BUILD_FOLDER=$DEBBUILD_DIR/$PACKAGE-$VERSION
+
+# create and rename the tarball
+mkdir -p $DEBBUILD_DIR
+if [ ! -f "$RELEASE_TARBALL" ]; then
+  wget -P $DEBBUILD_DIR $RELEASE_TARBALL_URL
+fi
+tar zxfP $DEBBUILD_DIR/v$VERSION.tar.gz -C $DEBBUILD_DIR
+mv $DEBBUILD_DIR/$PROJECT-$VERSION $DEBBUILD_DIR/$PACKAGE-$VERSION
+cd $DEBBUILD_DIR && tar zcfP $TARBALL_NAME $PACKAGE-$VERSION
+
+# check the go version
+if ! [ -x "$(command -v go)" ]; then
+  echo 'Error: go is not installed. Please install Go 1.14 and above'
+  exit 1
+fi
+
+NEED_GO_VERSION=14
+CURRENT_GO_VERSION=$(go version | awk '{print $3}' | sed 's/go//g' | sed 's/\./ /g' | awk '{print $2}')
+if [ $CURRENT_GO_VERSION -lt $NEED_GO_VERSION  ]; then
+  echo 'Error: go version is less than 1.14.0. Please install Go 1.14 and above'
+  exit
+fi
+
+# build_deb_package
+cp -rf  $SCRIPT_DIR/debian $DEB_BUILD_FOLDER
+cd $DEB_BUILD_FOLDER
+dpkg-buildpackage -us -uc
+cp $DEBBUILD_DIR/*.*deb $PROJECT_DIR
+rm -rf $DEBBUILD_DIR
diff --git a/shelter/dist/deb/debian/changelog b/shelter/dist/deb/debian/changelog
new file mode 100644
index 0000000..0d556ca
--- /dev/null
+++ b/shelter/dist/deb/debian/changelog
@@ -0,0 +1,17 @@
+shelter (0.6.1) unstable; urgency=low
+
+  * Update to version 0.6.1.
+
+ -- Hu Zhiming <zhiming.hu@intel.com>  Thu, 15 Apr 2021 09:30:00 +0000
+
+shelter (0.6.0-1) unstable; urgency=low
+
+  * Update to version 0.6.0.
+
+ -- Hu Zhiming <zhiming.hu@intel.com>  Sun, 07 Feb 2021 05:40:00 +0000
+
+shelter (0.5.2-1) unstable; urgency=low
+
+  * Initial release.
+
+ -- Hu Zhiming <zhiming.hu@intel.com>  Wed, Dec 30 2020 13:48:35 +0000
diff --git a/shelter/dist/deb/debian/compat b/shelter/dist/deb/debian/compat
new file mode 100644
index 0000000..ec63514
--- /dev/null
+++ b/shelter/dist/deb/debian/compat
@@ -0,0 +1 @@
+9
diff --git a/shelter/dist/deb/debian/control b/shelter/dist/deb/debian/control
new file mode 100644
index 0000000..409b47d
--- /dev/null
+++ b/shelter/dist/deb/debian/control
@@ -0,0 +1,12 @@
+Source: shelter
+Section: devel
+Priority: extra
+Maintainer: zhiming hu <zhiming.hu@intel.com>
+Build-Depends: debhelper (>=9)
+Standards-Version: 3.9.8
+Homepage: https://github.com/alibaba/inclavare-containers
+
+Package: shelter
+Architecture: amd64
+Depends: ${misc:Depends}, ${shlibs:Depends}
+Description: shelter is designed as a remote attestation tool for customer to verify if their workloads are loaded in a specified intel authorized sgx enclaved.
diff --git a/shelter/dist/deb/debian/rules b/shelter/dist/deb/debian/rules
new file mode 100755
index 0000000..99e214f
--- /dev/null
+++ b/shelter/dist/deb/debian/rules
@@ -0,0 +1,16 @@
+#!/usr/bin/make -f
+BUILD_ROOT := $(CURDIR)/debian/shelter
+BUILD_DIR := /usr/local/bin
+NAME := shelter
+
+export GO111MODULE := on
+
+%:
+	dh $@
+
+override_dh_auto_build:
+	make -C $(NAME)
+override_dh_auto_install:
+	install -d -p $(BUILD_ROOT)$(BUILD_DIR)
+	install -p -m 755 $(CURDIR)/$(NAME)/$(NAME) $(BUILD_ROOT)$(BUILD_DIR)
+override_dh_usrlocal:
diff --git a/shelter/dist/deb/debian/source/format b/shelter/dist/deb/debian/source/format
new file mode 100644
index 0000000..163aaf8
--- /dev/null
+++ b/shelter/dist/deb/debian/source/format
@@ -0,0 +1 @@
+3.0 (quilt)
diff --git a/shelter/dist/rpm/shelter.spec b/shelter/dist/rpm/shelter.spec
new file mode 100644
index 0000000..cc2b2d8
--- /dev/null
+++ b/shelter/dist/rpm/shelter.spec
@@ -0,0 +1,61 @@
+%define centos_base_release 1
+%define _debugsource_template %{nil}
+
+%global PROJECT inclavare-containers
+%global BIN_DIR /usr/local/bin
+
+Name: shelter
+Version: 0.6.0
+Release: %{centos_base_release}%{?dist}
+Summary: shelter is designed as a remote attestation tool for customer to verify if their workloads are loaded in a specified intel authorized sgx enclaved.
+
+Group: Development/Tools
+License: Apache License 2.0
+URL: https://github.com/alibaba/%{PROJECT}
+Source0: https://github.com/alibaba/%{PROJECT}/archive/v%{version}.tar.gz
+
+ExclusiveArch: x86_64
+
+%description
+shelter is designed as a remote attestation tool for customer to verify if their workloads are loaded in a specified intel authorized sgx enclaved.
+
+%prep
+%setup -q -n %{PROJECT}-%{version}
+
+%build
+# we cann't download go1.14 through 'yum install' in centos, so that wo check the go version in the '%build' section rather than in the 'BuildRequires' section.
+if ! [ -x "$(command -v go)" ]; then
+  echo 'Error: go is not installed. Please install Go 1.14 and above'
+  exit 1
+fi
+
+NEED_GO_VERSION=14
+CURRENT_GO_VERSION=$(go version | awk '{print $3}' | sed 's/go//g' | sed 's/\./ /g' | awk '{print $2}')
+if [ $CURRENT_GO_VERSION -lt $NEED_GO_VERSION  ]; then
+  echo 'Error: go version is less than 1.14.0. Please install Go 1.14 and above'
+  exit 1
+fi
+
+export GOPATH=${RPM_BUILD_DIR}/%{PROJECT}-%{version}
+export PATH=$PATH:${GOPATH}/bin
+export GO111MODULE=on
+pushd %{name}
+make
+popd
+
+%install
+install -d -p %{buildroot}%{BIN_DIR}
+install -p -m 755 %{name}/%{name} %{buildroot}%{BIN_DIR}
+
+%files
+%{BIN_DIR}/%{name}
+
+%changelog
+* Thu Apr 15 2021 Zhiming Hu <zhiming.hu@intel.com> - 0.6.1
+- Update to 0.6.1 and enable dacp remote attestation based on enclave-tls lib.
+
+* Thu Feb 07 2021 Zhiming Hu <zhiming.hu@intel.com> - 0.6.0
+- Update to 0.6.0 and enable dacp remote attestation based on wolsf-ssl lib.
+
+* Wed Dec 30 2020 Zhiming Hu <zhiming.hu@intel.com> - 0.5.2
+- Package init.
-- 
2.17.1

